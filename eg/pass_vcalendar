# Do satellite pass calculations, displaying the results in vCalendar
# format. The output may be redirected to a .vcal file. The start and
# end dates for the pass calculation can be passed as arguments to the
# 'source' statement, and default to 'today noon' and '+8' respectively.
# This whole thing (less the comments) could be wrapped up as a macro
# if desired.

#	CAVEAT: My ancient Palm desktop software appears not to properly
#	handle the switch between normal and daylight-saving  time
#	(a.k.a. summer time), in that predictions made before the switch
#	for events after the switch get assigned the wrong time, even
#	though the UT event time is correct in the emitted file. I have
#	not changed the event times to local time eg/flare_vcalendar
#	because the vcalendar standard specifies UT.

localize formatter

# We intend to use %date(zone=z) to format the event begin and end. We
# truncate the time to the previous minute.

tell formatter date_format %Y%m%dT%H%M00Z

# We intend to use %time to format the individual event times.

tell formatter time_format %I:%M:%S

# Supress the automatically-generated headers.

tell formatter header 0

# Provide the vCalendar event start tag, the start time, and the start
# of the event summary.

tell formatter template pass_start "BEGIN:VEVENT%n;DTSTART:%date(zone=z)%n;\
DALARM:%date(delta=-360,zone=z)%n;SUMMARY:%*name"

# Define the optional pass_finish template to provide the event end
# time, and the event end tag

tell formatter template pass_finish %n;DTEND:%date(zone=z)%n;END:VEVENT%n

# Eliminate the blank line that is inserted by default between passes

tell formatter template pass_pad ''

# The individual pass events get concatenated to the summary, with no newline.

tell formatter template pass ' %*event %time Az %*.0azimuth(bearing) Ele %*.0elevation'

# Override the above for rise/set, to suppress the elevation.

tell formatter template pass_horizon ' %*event %time Az %*.0azimuth(bearing)'

# Override the general template for appulses

tell formatter template pass_appulse ' %*event %*name(appulse) %time Az %*.0azimuth(bearing) Ele %*.0elevation'

# We turn off the date display.

tell formatter template pass_date ''

# Emit the start tag for the vCalendar data.

echo BEGIN:VCALENDAR

# Do the pass calculation. The -chronological is used for its side effect
# of placing the satellite name with the individual pass, rather than at
# the top of the data.

pass -chronological ${1:-today noon} ${2:-+8}

# Emit the end tag for the vCalendar data.

echo END:VCALENDAR
